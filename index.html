<!DOCTYPE html>
<html lang="ru">
	<head>
		<!-- Google tag (gtag.js) -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-VFFJE5E6D4"
		></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-VFFJE5E6D4");
		</script>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Калькулятор зарядки EV</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, Helvetica, Arial, sans-serif;
				background-color: var(--tg-theme-bg-color, #ffffff);
				color: var(--tg-theme-text-color, #000000);
				padding: 20px;
				max-width: 600px;
				margin: 0 auto;
			}

			.container {
				background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
				border-radius: 12px;
				padding: 20px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			h1 {
				font-size: 24px;
				margin-bottom: 20px;
				color: var(--tg-theme-text-color, #000000);
			}

			.form-group {
				margin-bottom: 20px;
			}

			label {
				display: block;
				margin-bottom: 10px;
				font-weight: 500;
				font-size: 17px;
				color: var(--tg-theme-text-color, #000000);
			}

			input[type="number"] {
				width: 100%;
				padding: 16px;
				border: 1px solid var(--tg-theme-hint-color, #ccc);
				border-radius: 10px;
				font-size: 20px;
				background-color: var(--tg-theme-bg-color, #ffffff);
				color: var(--tg-theme-text-color, #000000);
			}

			input[type="number"]:focus {
				outline: none;
				border-color: var(--tg-theme-button-color, #3390ec);
			}

			.selector {
				display: flex;
				gap: 8px;
				width: 100%;
			}

			.selector button {
				flex: 1;
				padding: 12px;
				background-color: var(--tg-theme-bg-color, #ffffff);
				color: var(--tg-theme-text-color, #000000);
				border: 2px solid var(--tg-theme-hint-color, #ccc);
				border-radius: 8px;
				font-size: 16px;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.selector button.active {
				background-color: var(--tg-theme-button-color, #3390ec);
				color: var(--tg-theme-button-text-color, #ffffff);
				border-color: var(--tg-theme-button-color, #3390ec);
			}

			.selector button:active {
				opacity: 0.8;
			}

			.result {
				margin-top: 20px;
				padding: 16px;
				background-color: var(--tg-theme-bg-color, #ffffff);
				border-radius: 8px;
			}

			.result h2 {
				font-size: 20px;
				margin-bottom: 12px;
				color: var(--tg-theme-text-color, #000000);
			}

			.result-value {
				font-size: 32px;
				font-weight: bold;
				color: var(--tg-theme-button-color, #3390ec);
				margin-bottom: 8px;
			}

			.result-details {
				font-size: 14px;
				color: var(--tg-theme-hint-color, #999999);
			}

			.error-message {
				margin-top: 12px;
				padding: 12px;
				background-color: #ff6b6b;
				color: white;
				border-radius: 8px;
				font-size: 14px;
				opacity: 0;
				transition: opacity 0.3s ease;
			}

			.error-message.show {
				opacity: 1;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>⚡ Калькулятор зарядки</h1>

			<div class="form-group">
				<label for="capacity">Ёмкость батареи (кВтч)</label>
				<input
					type="number"
					id="capacity"
					placeholder="напр., 75"
					step="0.1"
					min="0"
				/>
			</div>

			<div class="form-group">
				<label for="usable">Доступная ёмкость (%)</label>
				<input
					type="number"
					id="usable"
					placeholder="напр., 90"
					value="90"
					step="1"
					min="0"
					max="100"
				/>
			</div>

			<div class="form-group">
				<label for="current">Текущий заряд (%)</label>
				<input
					type="number"
					id="current"
					placeholder="напр., 20"
					step="1"
					min="0"
					max="100"
				/>
			</div>

			<div class="form-group">
				<label>Целевой заряд (%)</label>
				<div class="selector">
					<button
						type="button"
						class="target-btn active"
						data-value="80"
					>
						80%
					</button>
					<button type="button" class="target-btn" data-value="90">
						90%
					</button>
					<button type="button" class="target-btn" data-value="100">
						100%
					</button>
				</div>
			</div>

			<div class="error-message" id="errorMessage"></div>

			<div class="result" id="result">
				<h2>Требуется зарядить</h2>
				<div class="result-value" id="resultValue">0.0 кВтч</div>
				<div class="result-details" id="resultDetails"></div>
			</div>
		</div>

		<script>
			// Initialize Telegram WebApp
			let tg = window.Telegram.WebApp;
			tg.expand();
			tg.ready();

			// Apply Telegram theme
			document.body.style.backgroundColor =
				tg.themeParams.bg_color || "#ffffff";

			// Check version and load saved presets from Cloud Storage
			const version = parseFloat(tg.version || "6.0");
			if (version >= 6.9 && tg.CloudStorage) {
				tg.CloudStorage.getItem("carSpecs", function (err, value) {
					if (!err && value) {
						try {
							const specs = JSON.parse(value);
							if (specs.capacity)
								document.getElementById("capacity").value =
									specs.capacity;
							if (specs.usablePercent)
								document.getElementById("usable").value =
									specs.usablePercent;
						} catch (e) {
							console.error("Error loading saved presets:", e);
						}
					}
				});
			}

			function showError(message) {
				const errorEl = document.getElementById("errorMessage");
				errorEl.textContent = message;
				errorEl.classList.add("show");
			}

			function hideError() {
				document
					.getElementById("errorMessage")
					.classList.remove("show");
			}

			function getTargetValue() {
				const activeBtn = document.querySelector(".target-btn.active");
				return activeBtn ? parseFloat(activeBtn.dataset.value) : 80;
			}

			function calculate() {
				const capacity = parseFloat(
					document.getElementById("capacity").value
				);
				const usablePercent = parseFloat(
					document.getElementById("usable").value
				);
				const current = parseFloat(
					document.getElementById("current").value
				);
				const target = getTargetValue();

				// Validation
				if (
					!capacity ||
					!usablePercent ||
					isNaN(current) ||
					isNaN(target)
				) {
					document.getElementById("resultValue").textContent =
						"— кВтч";
					document.getElementById("resultDetails").innerHTML =
						"Заполните все поля для расчёта";
					hideError();
					return;
				}

				if (
					current < 0 ||
					current > 100 ||
					target < 0 ||
					target > 100
				) {
					document.getElementById("resultValue").textContent =
						"— кВтч";
					document.getElementById("resultDetails").innerHTML = "";
					showError("Процент заряда должен быть от 0 до 100");
					return;
				}

				if (target <= current) {
					document.getElementById("resultValue").textContent =
						"— кВтч";
					document.getElementById("resultDetails").innerHTML = "";
					showError("Целевой заряд должен быть больше текущего");
					return;
				}

				hideError();

				// Calculate usable capacity
				const usableCapacity = capacity * (usablePercent / 100);

				// Calculate required charge
				const chargeDifference = target - current;
				const requiredKWh = (chargeDifference / 100) * usableCapacity;

				// Display result
				document.getElementById("resultValue").textContent =
					requiredKWh.toFixed(2) + " кВтч";
				document.getElementById("resultDetails").innerHTML = `
                Доступная ёмкость: ${usableCapacity.toFixed(2)} кВтч<br>
                Зарядка с ${current}% до ${target}% (${chargeDifference}%)
            `;

				// Save presets automatically when calculation is successful
				savePresets(capacity, usablePercent);
			}

			function savePresets(capacity, usablePercent) {
				if (!capacity || !usablePercent) return;

				const specs = {
					capacity: capacity,
					usablePercent: usablePercent,
				};

				const version = parseFloat(tg.version || "6.0");
				if (version >= 6.9 && tg.CloudStorage) {
					tg.CloudStorage.setItem("carSpecs", JSON.stringify(specs));
				}
			}

			// Add event listeners to all inputs for live calculation
			const inputs = ["capacity", "usable", "current"];
			inputs.forEach((id) => {
				document
					.getElementById(id)
					.addEventListener("input", calculate);
			});

			// Add event listeners to target selector buttons
			document.querySelectorAll(".target-btn").forEach((btn) => {
				btn.addEventListener("click", function () {
					document
						.querySelectorAll(".target-btn")
						.forEach((b) => b.classList.remove("active"));
					this.classList.add("active");
					calculate();
				});
			});

			// Initial calculation to show result immediately
			calculate();
		</script>
	</body>
</html>
